<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡</title>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .edit-toggle-btn {
            background-color: #007bff;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 15px;
            display: block;
            margin-left: auto;
        }
        .edit-toggle-btn:hover {
            background-color: #0056b3;
        }
        #noteForm {
            display: none; /* é»˜è®¤éšè—è¡¨å• */
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"], textarea, input[type="file"] {
            width: calc(100% - 22px); /* Account for padding/border */
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        .note-item {
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            background-color: #fafafa;
        }
        .note-title {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
            margin-bottom: 8px;
        }
        .note-content {
            color: #666;
            margin-bottom: 10px;
            word-wrap: break-word;
        }
        .note-image {
            max-width: 100%;
            height: auto;
            margin-top: 10px;
            border-radius: 4px;
            display: block; /* ç¡®ä¿å›¾ç‰‡ç‹¬å ä¸€è¡Œ */
        }
        .note-date {
            font-size: 0.85em;
            color: #999;
            margin-bottom: 10px;
        }
        .copy-btn, .download-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
            margin-right: 5px;
        }
        .copy-btn:hover, .download-btn:hover {
            background-color: #0056b3;
        }
        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        .actions {
            margin-top: 10px;
        }
        .loading {
            text-align: center;
            color: #666;
        }
        .error {
            color: red;
            margin-top: 10px;
        }
        .sort-controls {
            margin-bottom: 15px;
        }
        .sort-controls select {
            padding: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“ å›¾ç‰‡</h1>
    
    <!-- æ·»åŠ ç¼–è¾‘æŒ‰é’® -->
    <button class="edit-toggle-btn" onclick="toggleEditForm()">âœï¸ ç¼–è¾‘</button>

    <!-- é»˜è®¤éšè—è¡¨å• -->
    <form id="noteForm">
        <div class="form-group">
            <label for="noteTitle">æ ‡é¢˜ (å¯é€‰)</label>
            <input type="text" id="noteTitle" placeholder="è¾“å…¥ç¬”è®°æ ‡é¢˜...">
        </div>
        <div class="form-group">
            <label for="noteContent">æ–‡æœ¬å†…å®¹</label>
            <textarea id="noteContent" placeholder="è¾“å…¥è¦ä¿å­˜çš„æ–‡æœ¬..."></textarea>
        </div>
        <div class="form-group">
            <label for="noteImage">å›¾ç‰‡ (å¯é€‰)</label>
            <input type="file" id="noteImage" accept="image/*">
        </div>
        <button type="submit">ğŸ’¾ ä¿å­˜</button>
    </form>

    <div id="errorDiv" class="error" style="display:none;"></div>

    <h2>ğŸ“‹ å›¾ç‰‡åˆ—è¡¨</h2>
    
    
    <div class="sort-controls">
        <label for="sortOrder">æ’åºæ–¹å¼: </label>
        <select id="sortOrder" onchange="loadNotes()">
            <option value="time_desc">æ—¶é—´ (æœ€æ–°ä¼˜å…ˆ)</option>
            <option value="time_asc">æ—¶é—´ (æœ€æ—©ä¼˜å…ˆ)</option>
            <option value="title_asc">æ ‡é¢˜ (A-Z)</option>
            <option value="title_desc">æ ‡é¢˜ (Z-A)</option>
        </select>
    </div>

    <div id="notesList" class="loading">åŠ è½½ä¸­...</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
   
    const SUPABASE_URL = 'https://yjbnqdrnoetgmmrtkszo.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_5z0BoTQwqPwWGaOetcVf0g_UknvjY9B';

    if (!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL.includes('your-project-id')) {
        alert(' URL å’Œ Anon Keyï¼');
        console.error('Supabase credentials are missing or incorrect.');
        document.getElementById('notesList').textContent = 'é”™è¯¯ï¼šè¯·é…ç½® Supabase ä¿¡æ¯ã€‚';
        throw new Error('Supabase credentials are missing or incorrect.');
    }

    const supabase1 = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const noteForm = document.getElementById('noteForm');
    const noteTitleInput = document.getElementById('noteTitle');
    const noteContentInput = document.getElementById('noteContent');
    const noteImageInput = document.getElementById('noteImage');
    const notesListDiv = document.getElementById('notesList');
    const errorDiv = document.getElementById('errorDiv');
    const sortOrderSelect = document.getElementById('sortOrder'); // æ’åºé€‰æ‹©æ¡†

   
    noteForm.addEventListener('submit', async (e) => {
        e.preventDefault(); // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤

        const title = noteTitleInput.value.trim();
        const content = noteContentInput.value.trim();
        const imageFile = noteImageInput.files[0];

        if (!content && !imageFile) {
            showError('è¯·è¾“å…¥æ–‡æœ¬å†…å®¹æˆ–é€‰æ‹©ä¸€å¼ å›¾ç‰‡ã€‚');
            return;
        }

        try {
            let imageUrl = null;
            if (imageFile) {
               
                const fileExtension = imageFile.name.split('.').pop().toLowerCase();
                const fileName = `${Date.now()}.${fileExtension}`; // ä¾‹å¦‚: 1772271341554.png

                const contentType = getContentType(imageFile.name);
                console.log('å‡†å¤‡ä¸Šä¼ æ–‡ä»¶:', fileName, 'ç±»å‹:', contentType);

                const { data: uploadData, error: uploadError } = await supabase1
                    .storage
                    .from('ntoes')
                    .upload(fileName, imageFile, { 
                        cacheControl: '3600',
                        upsert: false,
                        contentType: contentType
                    });

                if (uploadError) {
                    console.error('Supabase Storage Upload Error:', uploadError);
                    throw uploadError;
                }
                console.log('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ:', uploadData);

                
                const { data: publicUrlData } = supabase1
                    .storage
                    .from('ntoes')
                    .getPublicUrl(fileName);

                imageUrl = publicUrlData.publicUrl;
                console.log('ç”Ÿæˆçš„å…¬å¼€ URL:', imageUrl);
            }

            const { error: insertError } = await supabase1
                .from('not')
                .insert([
                    { title: title || 'æ— æ ‡é¢˜ç¬”è®°', content: content, image_url: imageUrl }
                ]);

            if (insertError) {
                throw insertError;
            }

            
            noteForm.reset();
            hideError();
            loadNotes();

        } catch (error) {
            console.error('ä¿å­˜ç¬”è®°å¤±è´¥:', error);
            showError(`ä¿å­˜å¤±è´¥: ${error.message}`);
        }
    });

  
    async function loadNotes() {
        try {
            let query = supabase1.from('not').select('*');
            
            
            const selectedSort = sortOrderSelect.value;
            switch(selectedSort) {
                case 'time_desc':
                    query = query.order('inserted_at', { ascending: false });
                    break;
                case 'time_asc':
                    query = query.order('inserted_at', { ascending: true });
                    break;
                case 'title_asc':
                    query = query.order('title', { ascending: true });
                    break;
                case 'title_desc':
                    query = query.order('title', { ascending: false });
                    break;
                default:
                    query = query.order('inserted_at', { ascending: false });
            }

            const { data: notes, error } = await query;

            if (error) {
                throw error;
            }

            renderNotes(notes);
        } catch (error) {
            console.error('åŠ è½½ç¬”è®°å¤±è´¥:', error);
            notesListDiv.innerHTML = `<p class="error">åŠ è½½å›¾ç‰‡å¤±è´¥: ${error.message}</p>`;
        }
    }


    function renderNotes(notes) {
        if (!notes || notes.length === 0) {
            notesListDiv.innerHTML = '<p>æš‚æ— å›¾ç‰‡ã€‚</p>';
            return;
        }

        notesListDiv.innerHTML = notes.map(note => `
            <div class="note-item">
                <div class="note-title">${escapeHtml(note.title)}</div>
                <div class="note-content">${escapeHtml(note.content || '')}</div>
                ${note.image_url ? `<img src="${note.image_url}" alt="Note Image" class="note-image">` : ''}
                <div class="note-date">${new Date(note.inserted_at).toLocaleString()}</div>
                <div class="actions">
                    <button class="copy-btn" onclick="copyText('${escapeHtmlForJs(note.content || '')}')">ğŸ“‹ å¤åˆ¶æ–‡æœ¬</button>
                    ${note.image_url ? `<button class="download-btn" onclick="downloadImage('${note.image_url}', '${note.title || 'image'}')">ğŸ“¥ ä¸‹è½½å›¾ç‰‡</button>` : ''}
                    <button class="delete-btn" onclick="deleteNote(${note.id})">ğŸ—‘ï¸ åˆ é™¤</button>
                </div>
            </div>
        `).join('');
    }


    function copyText(text) {
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => {
            alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        }).catch(err => {
            console.error('å¤åˆ¶å¤±è´¥', err);
            // Fallback for older browsers if needed
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼ï¼ˆä½¿ç”¨å¤‡ç”¨æ–¹æ³•ï¼‰');
        });
    }

    function downloadImage(url, title) {
        if (!url) return;
        const a = document.createElement('a');
        a.href = url;
        a.download = `${title || 'image'}.jpg`; // å¯ä»¥å°è¯•ä» URL è§£æå®é™…æ‰©å±•åï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    async function deleteNote(noteId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤å›¾ç‰‡å—ï¼Ÿ')) return;

        try {
            const noteToDelete = document.querySelector(`.note-item:has(.delete-btn[onclick="deleteNote(${noteId})"])`);
            
            
            const imageElement = noteToDelete.querySelector('.note-image');
            if (imageElement && imageElement.src) {
                const publicUrl = imageElement.src;
              
                const pathParts = new URL(publicUrl).pathname.split('/');
                const fileName = pathParts[pathParts.length - 1];
                
                const { error: deleteFileError } = await supabase1
                    .storage
                    .from('ntoes') 
                    .remove([fileName]);

                if (deleteFileError) {
                    console.warn('åˆ é™¤å›¾ç‰‡æ–‡ä»¶å¤±è´¥:', deleteFileError.message); 
                }
            }

        
            const { error: deleteError } = await supabase1
                .from('not') // è¡¨å
                .delete()
                .eq('id', noteId);

            if (deleteError) {
                throw deleteError;
            }

            loadNotes();

        } catch (error) {
            console.error('åˆ é™¤å›¾ç‰‡å¤±è´¥:', error);
            showError(`åˆ é™¤å¤±è´¥: ${error.message}`);
        }
    }


    function toggleEditForm() {
        if (noteForm.style.display === 'none' || noteForm.style.display === '') {
            noteForm.style.display = 'block';
        } else {
            noteForm.style.display = 'none';
        }
    }


    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    function escapeHtmlForJs(str) {
        return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }

    function showError(message) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }

    function hideError() {
        errorDiv.style.display = 'none';
    }

function getContentType(fileName) {
    const extension = fileName.toLowerCase().split('.').pop();
    const mimeTypes = {
    
        'jpg': 'image/jpeg',
        'jpeg': 'image/jpeg',
        'png': 'image/png',
        'gif': 'image/gif',
		'html':'text/html',
        'webp': 'image/webp',
        'svg': 'image/svg+xml',
        'bmp': 'image/bmp',
        'ico': 'image/x-icon',
        'tiff': 'image/tiff',
        'tif': 'image/tiff',
        'pdf': 'application/pdf',
        'txt': 'text/plain',
        'json': 'application/json',
        'zip': 'application/zip',
        'doc': 'application/msword',
        'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'xls': 'application/vnd.ms-excel',
        'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
	
    };
    return mimeTypes[extension] || 'application/octet-stream';
}

 
    document.addEventListener('DOMContentLoaded', () => {
        loadNotes();
    });
</script>

</body>
</html>